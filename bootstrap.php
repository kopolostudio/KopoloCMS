<?php /** * Загрузочный файл Kopolo CMS *//***** Подготовительные действия *****/session_cache_limiter('private_no_expire');session_cache_limiter('nocache');/* Подключение базовых библиотек */require_once 'PEAR.php';require_once 'PEAR/ErrorStack.php';require_once 'MDB2.php';require_once 'DB/DataObject.php';require_once 'HTTP.php';require_once (SMARTY_DIR . 'Smarty.class.php');/* Подключение к БД */$options = &PEAR::getStaticProperty('DB_DataObject','options');$options = array(    'debug' => 0,    'database'  => KOPOLO_DSN,    'db_driver' => 'MDB2',);/* Регистрация автолоадера */spl_autoload_register('kopolo_autoload');/***** Загрузка страницы *****//* Если кеш не получен - получение контента *///разбор URL$request_uri = explode('?',isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '/');$request_url = $request_uri[0];//преобразование кириллического URL (Punycode) в Unicodeif (KOPOLO_USE_ENCODED_URLS) {    require "Net/IDNA2.php";    $idna = new Net_IDNA2();    $_SERVER['SERVER_NAME'] = $_SERVER['HTTP_HOST'] = $idna->decode($_SERVER['SERVER_NAME']);}//получение ID сайта$nicks = explode("/", trim($request_url, "/")); //массив с псевдонимами страниц$sites = new Module_Sites();if ($nicks[0] == 'admin') {    array_shift($nicks);    $site_id = ADMIN_PANEL_SITE_ID;    $sites->get($site_id);    $site = $sites;} else {    //если мультисайтовость отключена, загружаем сразу сайт с указанным ID    if (defined('MULTISITING') && MULTISITING===false && defined('SITE_ID')) {        $site_id = SITE_ID;        $sites->get($site_id);        $site = $sites;    } else {        $site = $sites->getSite($_SERVER['HTTP_HOST']);        $site_id = $site->st_id;    }}//TO DO: исключение для неопределеного $site_id, сообщение для неактивного сайтаif ($site_id == false) {    die('Undefined domain &laquo;' . $_SERVER['HTTP_HOST'] .'&raquo;. Add domain in Sites module.');} else {    Kopolo_Registry::set('site_id', $site_id);    Kopolo_Registry::set('theme', !empty($site->st_theme)?$site->st_theme:KOPOLO_DEFAULT_THEME);        $url = $request_url;        /* если включена поддержка мульиязычности, получаем язык сайта */    if (MULTILANG==true) {        $lang = new Module_Sites_Langs();        $langs = $lang->getLangs(Kopolo_Registry::get('site_id'));                if (count($langs)) {            Kopolo_Registry::set('langs', $langs);                        /* если первый элемент в URL совпадает с одним из языков, выбираем этот язык */            if (isset($langs[$nicks[0]])) {                $site_lang = $nicks[0];                array_shift($nicks);                Kopolo_Registry::set('default_lang', false);                                /* из url вырезаем метку языка */                $url = substr($url, 1+strlen($site_lang));            } else {                /* иначе используем язык по умолчанию (первый в списке языков) */                $langs_ar = array_keys($langs);                $site_lang = $langs_ar[0];                Kopolo_Registry::set('default_lang', true);            }            Kopolo_Registry::set('lang', $site_lang);        }    }        Kopolo_Registry::set('uri', $url);    Kopolo_Registry::set('full_uri', $url . (!empty($_SERVER['QUERY_STRING']) ? ('?' . $_SERVER['QUERY_STRING']) : ''));    Kopolo_Registry::set('url', 'http://' .  $_SERVER['HTTP_HOST'] . $url);}/** * Автолоадер: автоматически загружает файл класса при его вызове * Знак "_" - разделитель директорий *  * @param string $classname */function kopolo_autoload($classname){       $classpath = str_replace("_", "/", $classname);    $absclasspath = KOPOLO_PATH . $classpath . '.php';        if (file_exists($absclasspath)) {        require_once($absclasspath);    } else {        //TO DO: это порнография, а не вывод ошибки        $backtrace = debug_backtrace();        $file = isset($backtrace[0]['file']) ? $backtrace[0]['file'] : 'undefined';        $line = isset($backtrace[0]['line']) ? $backtrace[0]['line'] : 'undefined';        $error = 'Autoload error of class -' . $classname . '-: file -' . $absclasspath . '- not exists. (called in file -' . $file . '-, line -' . $line . '-).';                if (isset($_GET['debug'])) {            echo $error;            echo '<pre>'; print_r ($backtrace); echo '</pre>';        } else {            Kopolo_Log::write($error);        }    }}